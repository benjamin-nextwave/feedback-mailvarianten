---
phase: 05-public-feedback-form
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/feedback/[slug]/_components/FeedbackForm.tsx
  - src/app/feedback/[slug]/_components/ReadOnlyView.tsx
autonomous: false

must_haves:
  truths:
    - "Email variants display in cards grouped by type with section headers (Eerste mail, Opvolgmail 1, Opvolgmail 2)"
    - "Each variant card shows Variant [number] label, subject line, and email body preview"
    - "Per-variant feedback textarea labeled Jouw feedback with Dutch placeholder"
    - "Submit button Feedback versturen validates at least one feedback field is filled"
    - "Dutch validation error displays when no feedback provided"
    - "Success message Bedankt! Je feedback is succesvol verstuurd. displays after submission"
    - "Client revisiting completed form sees read-only view with submitted feedback"
  artifacts:
    - path: "src/app/feedback/[slug]/_components/FeedbackForm.tsx"
      provides: "Interactive feedback form with variant cards, textareas, Zod validation, and submission"
      min_lines: 100
    - path: "src/app/feedback/[slug]/_components/ReadOnlyView.tsx"
      provides: "Read-only display of submitted feedback grouped by variant"
      min_lines: 40
  key_links:
    - from: "src/app/feedback/[slug]/_components/FeedbackForm.tsx"
      to: "src/lib/actions/feedback-actions.ts"
      via: "submitFeedbackAction call on form submit"
      pattern: "submitFeedbackAction"
    - from: "src/app/feedback/[slug]/_components/FeedbackForm.tsx"
      to: "zod schema"
      via: "zodResolver for at-least-one-field validation"
      pattern: "superRefine"
    - from: "src/app/feedback/[slug]/_components/FeedbackForm.tsx"
      to: "variant cards grouped by email_type"
      via: "Array.reduce grouping with EMAIL_TYPE_LABELS"
      pattern: "reduce.*email_type"
---

<objective>
Build the interactive FeedbackForm Client Component and ReadOnlyView component for the public feedback page. FeedbackForm displays email variants in grouped cards with per-variant feedback textareas, validates that at least one field has feedback using Zod superRefine, submits via Server Action, and shows a success message. ReadOnlyView displays previously submitted feedback in a read-only format for completed forms.

Purpose: Delivers the core user-facing value of the entire platform -- the frictionless feedback submission experience for clients.
Output: Complete interactive feedback form and read-only view components.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-public-feedback-form/05-RESEARCH.md
@.planning/phases/05-public-feedback-form/05-01-SUMMARY.md

# Key source files to reference
@src/lib/actions/feedback-actions.ts
@src/app/feedback/[slug]/page.tsx
@src/types/database.types.ts
@src/components/ui/card.tsx
@src/components/ui/button.tsx
@src/components/ui/textarea.tsx
@src/app/dashboard/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: FeedbackForm Client Component with validation and submission</name>
  <files>
    src/app/feedback/[slug]/_components/FeedbackForm.tsx
  </files>
  <action>
    Create `src/app/feedback/[slug]/_components/FeedbackForm.tsx` as a Client Component ("use client"):

    **Props interface:**
    Accept form prop with shape matching page.tsx's FormWithVariants type (define locally or import):
    ```typescript
    interface FeedbackFormProps {
      form: {
        id: string
        client_name: string
        slug: string
        webhook_url: string | null
        email_variants: Array<{
          id: string
          email_type: 'eerste_mail' | 'opvolgmail_1' | 'opvolgmail_2'
          variant_number: number
          subject_line: string
          email_body: string
          sort_order: number
        }>
      }
    }
    ```

    **Zod Schema (defined inside file or above component):**
    - Create schema dynamically based on form.email_variants:
      ```typescript
      // Build schema with dynamic keys based on variant IDs
      const buildFeedbackSchema = (variantIds: string[]) => {
        const shape: Record<string, z.ZodString | z.ZodOptional<z.ZodString>> = {}
        variantIds.forEach(id => {
          shape[`feedback_${id}`] = z.string().optional()
        })
        return z.object(shape).superRefine((data, ctx) => {
          const hasAnyFeedback = Object.values(data).some(
            val => val && val.trim().length > 0
          )
          if (!hasAnyFeedback) {
            ctx.addIssue({
              code: 'custom',
              message: 'Vul minimaal een feedbackveld in om je feedback te versturen.',
              path: [],
            })
          }
        })
      }
      ```
    - Use `useMemo` to create the schema once from variant IDs

    **React Hook Form setup:**
    - `useForm` with `zodResolver(schema)`, `mode: 'onSubmit'` (not onBlur -- superRefine cross-field validation should only trigger on submit to avoid confusing mid-typing errors), `reValidateMode: 'onChange'`
    - Default values: all feedback fields as empty strings, keyed by `feedback_${variant.id}`

    **State:**
    - `const [isSubmitting, setIsSubmitting] = useState(false)`
    - `const [isSuccess, setIsSuccess] = useState(false)`
    - `const [submitError, setSubmitError] = useState<string | null>(null)`

    **onSubmit handler:**
    1. Set isSubmitting true, clear submitError
    2. Build feedbackEntries array: filter form values where value is non-empty, map to `{ variant_id: key.replace('feedback_', ''), feedback_text: value.trim() }`
    3. Call `submitFeedbackAction(form.id, form.slug, form.webhook_url, feedbackEntries)` from `@/lib/actions/feedback-actions`
    4. If result.success is false, set submitError to result.error
    5. If result.success is true, set isSuccess to true
    6. Set isSubmitting false in finally block

    **Render - Success state (isSuccess === true):**
    - Show success card with green styling (bg-green-50 border border-green-200 rounded-lg p-8)
    - CheckCircle icon from lucide-react (h-12 w-12 text-green-600)
    - Heading: "Bedankt!" (text-2xl font-bold)
    - Message: "Je feedback is succesvol verstuurd." (text-muted-foreground)
    - Additional: "Je kunt dit venster nu sluiten."

    **Render - Form state:**
    1. Group variants by email_type using Array.reduce (same pattern as dashboard/[id]/page.tsx):
       ```typescript
       const EMAIL_TYPE_LABELS = { eerste_mail: 'Eerste mail', opvolgmail_1: 'Opvolgmail 1', opvolgmail_2: 'Opvolgmail 2' }
       const EMAIL_TYPE_ORDER = ['eerste_mail', 'opvolgmail_1', 'opvolgmail_2'] as const
       ```
    2. Wrap in `<form onSubmit={handleSubmit(onSubmit)}>` (handleSubmit from react-hook-form)
    3. For each email type section (only render if variants exist for that type):
       - Section header: `<h2 className="text-xl font-semibold">{EMAIL_TYPE_LABELS[type]}</h2>`
       - For each variant in the section:
         - Card component wrapping:
           - CardHeader with CardTitle: "Variant {variant_number}" (text-base font-medium)
           - CardContent with:
             - Subject line display: `<div className="text-sm font-medium mb-2">Onderwerp: {variant.subject_line}</div>`
             - Email body preview: `<div className="bg-gray-50 rounded-lg p-4 text-sm whitespace-pre-wrap mb-4">{variant.email_body}</div>`
             - Textarea for feedback:
               - Label: "Jouw feedback" (use `<label>` with htmlFor)
               - shadcn Textarea component
               - Placeholder: "Schrijf hier je feedback over deze variant..."
               - Register with react-hook-form: `{...register('feedback_' + variant.id)}`
               - Show field-level error if any (from formState.errors)
    4. Form-level validation error display:
       - If `formState.errors.root` or form-level error exists, show: `<p className="text-sm text-red-500">{error message}</p>`
       - Note: superRefine with path: [] creates a root-level error. Access it via `formState.errors?.root?.message` or check for the root error in the errors object. React Hook Form maps path: [] errors differently -- test and adjust. May need to use `setError('root', { message })` manually if Zod path: [] doesn't map to root automatically.
    5. Submit error display (from Server Action):
       - If submitError is set, show red alert: `<p className="text-sm text-red-500">{submitError}</p>`
    6. Submit button at bottom:
       - shadcn Button component, type="submit"
       - Text: "Feedback versturen"
       - `disabled={isSubmitting}`
       - Show loading state: when isSubmitting, show spinner icon (Loader2 from lucide-react with animate-spin) and text "Bezig met versturen..."
       - Full width on mobile: `className="w-full sm:w-auto"`

    **Styling notes:**
    - Use consistent spacing: space-y-8 for sections, space-y-4 within sections
    - Cards should have subtle shadow (default Card styling from shadcn)
    - Email body preview in bg-gray-50 to distinguish from surrounding content (like an email preview)
    - Keep it clean and professional -- this is client-facing

    **Important implementation details:**
    - Use HTML entities for quotes in JSX (same pattern as Plan 04-03: &quot; or &#39;) to satisfy ESLint react/no-unescaped-entities
    - Import submitFeedbackAction from '@/lib/actions/feedback-actions'
    - Import Card, CardContent, CardHeader, CardTitle from '@/components/ui/card'
    - Import Button from '@/components/ui/button'
    - Import Textarea from '@/components/ui/textarea'
    - Import { CheckCircle, Loader2 } from 'lucide-react'
    - Import { useForm } from 'react-hook-form'
    - Import { zodResolver } from '@hookform/resolvers/zod'
    - Import { z } from 'zod'
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - File exists: `src/app/feedback/[slug]/_components/FeedbackForm.tsx`
    - File contains 'use client' directive
    - File imports submitFeedbackAction
    - File contains Zod schema with superRefine
    - File contains EMAIL_TYPE_LABELS and EMAIL_TYPE_ORDER constants
    - File renders variant cards grouped by type
    - File handles success state with "Bedankt!" message
    - File has "Feedback versturen" submit button
  </verify>
  <done>
    FeedbackForm Client Component renders email variants grouped by type in cards, provides per-variant feedback textareas with Dutch labels and placeholders, validates at least one field is filled using Zod superRefine with Dutch error message, submits via submitFeedbackAction Server Action, shows loading state during submission, and displays success message "Bedankt! Je feedback is succesvol verstuurd." after successful submission.
  </done>
</task>

<task type="auto">
  <name>Task 2: ReadOnlyView component for completed forms</name>
  <files>
    src/app/feedback/[slug]/_components/ReadOnlyView.tsx
  </files>
  <action>
    Create `src/app/feedback/[slug]/_components/ReadOnlyView.tsx` as a Server Component (no 'use client' directive):

    **Props interface:**
    ```typescript
    interface ReadOnlyViewProps {
      form: {
        id: string
        client_name: string
        email_variants: Array<{
          id: string
          email_type: 'eerste_mail' | 'opvolgmail_1' | 'opvolgmail_2'
          variant_number: number
          subject_line: string
          email_body: string
          sort_order: number
        }>
      }
      feedbackResponses: Array<{
        id: string
        variant_id: string
        feedback_text: string
        submitted_at: string
      }>
    }
    ```

    **Implementation:**
    1. Create a Map from feedbackResponses keyed by variant_id for O(1) lookup:
       `const feedbackByVariant = new Map(feedbackResponses.map(r => [r.variant_id, r]))`

    2. Group variants by email_type using same Array.reduce pattern and EMAIL_TYPE_LABELS/EMAIL_TYPE_ORDER constants as FeedbackForm

    3. Show success banner at top:
       - Green card (bg-green-50 border border-green-200 rounded-lg p-6)
       - CheckCircle icon from lucide-react (h-8 w-8 text-green-600)
       - Text: "Bedankt! Je feedback is succesvol verstuurd."
       - Subtext: "Hieronder kun je je ingezonden feedback nog terugzien."

    4. For each email type section (same grouping as FeedbackForm):
       - Section header: `<h2 className="text-xl font-semibold">{label}</h2>`
       - For each variant:
         - Card with:
           - CardHeader/CardTitle: "Variant {variant_number}" (text-base)
           - CardContent:
             - Subject line: "Onderwerp: {subject_line}"
             - Email body in bg-gray-50 preview
             - Feedback display:
               - If feedback exists for this variant (check feedbackByVariant Map):
                 - Label: "Jouw feedback" (text-sm font-medium)
                 - Display feedback text in bg-blue-50 border border-blue-200 rounded-lg p-4 (use blue instead of green to differentiate from success banner)
               - If no feedback for this variant:
                 - Gray text: "Geen feedback gegeven voor deze variant" (italic, text-muted-foreground)

    **Styling:**
    - Match the card layout and spacing from FeedbackForm for visual consistency
    - All textareas/inputs should NOT be present (read-only, no form elements)
    - Use consistent spacing: space-y-8 for sections, space-y-4 within

    **Imports:**
    - Card, CardContent, CardHeader, CardTitle from '@/components/ui/card'
    - CheckCircle from 'lucide-react'
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - File exists: `src/app/feedback/[slug]/_components/ReadOnlyView.tsx`
    - File does NOT contain 'use client' (Server Component)
    - File displays feedback text for variants that have feedback
    - File shows "Geen feedback gegeven" for variants without feedback
    - File shows success banner "Bedankt! Je feedback is succesvol verstuurd."
    - Build output shows /feedback/[slug] route
  </verify>
  <done>
    ReadOnlyView component displays submitted feedback grouped by variant type, shows green success banner, displays feedback text per variant in blue-highlighted cards, shows "Geen feedback gegeven" for variants without feedback, and renders as a Server Component without interactive elements.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete public feedback flow</name>
  <what-built>Complete public feedback form at /feedback/[slug] with interactive submission and read-only view after completion. This is the core value delivery of the entire platform.</what-built>
  <how-to-verify>
    1. Run `npm run dev` and navigate to an active form's public URL (copy from dashboard)
    2. Verify page shows:
       - "NextWave Solutions" branding text
       - "Invulformulier voor [Klantnaam]" heading
       - Intro text about leaving feedback
       - Email variants grouped by type (Eerste mail, Opvolgmail 1, etc.)
       - Each variant shows number, subject line, and email body preview
       - "Jouw feedback" textarea per variant with Dutch placeholder
       - "Feedback versturen" submit button
    3. Try submitting with ALL textareas empty -- should show Dutch validation error "Vul minimaal een feedbackveld in"
    4. Fill in feedback for at least one variant, click "Feedback versturen"
    5. Verify success message "Bedankt! Je feedback is succesvol verstuurd." appears
    6. Refresh the page -- should show read-only view with submitted feedback
    7. Check dashboard form detail -- form status should show "Ingeleverd" (completed)
    8. Navigate to an invalid slug like /feedback/does-not-exist -- should show 404 page

    NOTE: If Supabase is not yet configured, this test requires a running Supabase instance with the migration applied. If not available, verify build succeeds and visual inspection of components.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes without errors
- `npm run build` completes successfully with /feedback/[slug] route
- FeedbackForm renders variant cards grouped by type
- FeedbackForm validates at least one feedback field with Dutch error
- FeedbackForm submits via Server Action and shows success message
- ReadOnlyView displays submitted feedback per variant
- Invalid slugs return 404 with Dutch message
- Active forms show interactive form, completed forms show read-only view
</verification>

<success_criteria>
1. Email variants display in cards grouped by type with Dutch section headers
2. Each variant card shows variant number, subject line, and email body preview
3. Per-variant feedback textarea labeled "Jouw feedback" with Dutch placeholder
4. Submit button "Feedback versturen" validates at least one field is filled
5. Dutch validation error "Vul minimaal een feedbackveld in" displays when all empty
6. Success message "Bedankt! Je feedback is succesvol verstuurd." displays after submission
7. Client revisiting completed form sees read-only view with previously submitted feedback
8. No re-submission possible on completed forms
</success_criteria>

<output>
After completion, create `.planning/phases/05-public-feedback-form/05-02-SUMMARY.md`
</output>
