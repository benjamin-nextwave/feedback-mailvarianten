---
phase: 05-public-feedback-form
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260211000000_add_anon_select_feedback.sql
  - src/lib/actions/feedback-actions.ts
  - src/app/feedback/[slug]/page.tsx
  - src/app/feedback/[slug]/not-found.tsx
autonomous: true

must_haves:
  truths:
    - "Public page at /feedback/[slug] loads without authentication"
    - "Invalid slug returns 404 page with Dutch message"
    - "Active form routes to interactive feedback form component"
    - "Completed form routes to read-only view component"
    - "Submission saves non-empty feedback to feedback_responses table"
    - "Form status updates to completed after submission"
    - "Webhook POST fires if webhook_url is configured (fire-and-forget)"
  artifacts:
    - path: "supabase/migrations/20260211000000_add_anon_select_feedback.sql"
      provides: "Anonymous SELECT policy on feedback_responses for RLS compatibility"
      contains: "CREATE POLICY"
    - path: "src/lib/actions/feedback-actions.ts"
      provides: "submitFeedbackAction Server Action"
      exports: ["submitFeedbackAction"]
    - path: "src/app/feedback/[slug]/page.tsx"
      provides: "Public feedback page with data fetch and routing logic"
      min_lines: 50
    - path: "src/app/feedback/[slug]/not-found.tsx"
      provides: "Dutch 404 page for invalid slugs"
      min_lines: 10
  key_links:
    - from: "src/app/feedback/[slug]/page.tsx"
      to: "supabase forms + email_variants"
      via: "createClient server-side query filtered by slug"
      pattern: "eq.*slug"
    - from: "src/lib/actions/feedback-actions.ts"
      to: "supabase feedback_responses + forms"
      via: "insert feedback then update form status"
      pattern: "from.*feedback_responses.*insert"
    - from: "src/lib/actions/feedback-actions.ts"
      to: "webhook_url"
      via: "fire-and-forget fetch with keepalive"
      pattern: "keepalive.*true"
---

<objective>
Create the data layer and page routing for the public feedback form. This includes a Server Action for feedback submission with fire-and-forget webhook, an RLS migration to fix a missing anonymous SELECT policy on feedback_responses, and the Server Component page that fetches form data and routes between the interactive form (for active forms) and read-only view (for completed forms).

Purpose: Establishes the backend foundation and page entry point that Plan 05-02 builds the interactive UI on top of.
Output: Working Server Action, RLS migration SQL, page routing with 404 handling.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-public-feedback-form/05-RESEARCH.md

# Key source files to reference for patterns
@src/lib/supabase/server.ts
@src/lib/actions/form-actions.ts
@src/types/database.types.ts
@src/app/dashboard/[id]/page.tsx
@src/app/dashboard/[id]/not-found.tsx
@supabase/migrations/20260210000000_create_initial_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: RLS migration + submitFeedbackAction Server Action</name>
  <files>
    supabase/migrations/20260211000000_add_anon_select_feedback.sql
    src/lib/actions/feedback-actions.ts
  </files>
  <action>
    **RLS Migration:**
    Create `supabase/migrations/20260211000000_add_anon_select_feedback.sql` with:
    - Add SELECT policy on feedback_responses for anon role: `CREATE POLICY "Anonymous users can read feedback_responses" ON feedback_responses FOR SELECT TO anon USING (true);`
    - This is REQUIRED because PostgreSQL SELECTs the newly inserted row to return it to the client. Without this policy, anonymous INSERT operations fail silently. The original migration (20260210) only has INSERT WITH CHECK but no SELECT USING for anon on feedback_responses.
    - Also add UPDATE policy on forms for anon role to allow status change to 'completed': `CREATE POLICY "Anonymous users can update form status" ON forms FOR UPDATE TO anon USING (true) WITH CHECK (status = 'completed');`
    - The WITH CHECK ensures anon can only set status to 'completed', not change other fields maliciously.

    **Server Action:**
    Create `src/lib/actions/feedback-actions.ts` as a Server Action ("use server") with:

    1. Export `submitFeedbackAction(formId: string, slug: string, webhookUrl: string | null, feedbackEntries: Array<{ variant_id: string; feedback_text: string }>)`:
       - Use `createClient` from `@/lib/supabase/server` (same pattern as form-actions.ts)
       - Validate that feedbackEntries is non-empty array (server-side guard)
       - Filter out entries where feedback_text is empty or whitespace-only
       - If no entries remain after filtering, return `{ success: false, error: 'Geen feedback om te versturen' }`
       - Batch INSERT all feedback entries into `feedback_responses` table with form_id, variant_id, feedback_text, submitted_at (new Date().toISOString())
       - Use type assertion `as any` for Supabase insert (same pattern as form-actions.ts for SSR typing issues)
       - On insert error, return `{ success: false, error: 'Er ging iets mis bij het opslaan van je feedback' }`
       - UPDATE forms table: set status to 'completed' where id = formId
       - On update error, log but continue (feedback is already saved, status update is secondary)
       - Fire-and-forget webhook: if webhookUrl is truthy, call `fetch(webhookUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), keepalive: true }).catch(err => console.error('Webhook failed:', err))`
       - Webhook payload shape: `{ form_id, client_name: string, slug, submitted_at: string, feedback_count: number, responses: Array<{ variant_id: string, feedback_text: string }> }`
       - Note: client_name is NOT available in the action params. Fetch it from the form data before webhook. Query the form to get client_name: `const { data: formData } = await supabase.from('forms').select('client_name').eq('id', formId).single()` -- do this BEFORE the status update.
       - Call `revalidatePath('/feedback/' + slug)` to refresh the page (shows read-only view after reload)
       - Return `{ success: true }`

    Important: Do NOT call redirect() from this action. The Client Component handles success state display.
    Important: Use `keepalive: true` on webhook fetch so it completes even if page navigation happens.
    Important: Do NOT await the webhook fetch call -- fire and forget.
  </action>
  <verify>
    - TypeScript compilation: `npx tsc --noEmit` passes
    - File exists: `supabase/migrations/20260211000000_add_anon_select_feedback.sql`
    - File exists: `src/lib/actions/feedback-actions.ts`
    - Server Action exports submitFeedbackAction function
    - Migration SQL contains SELECT policy for anon on feedback_responses
    - Migration SQL contains UPDATE policy for anon on forms
  </verify>
  <done>
    submitFeedbackAction Server Action is complete with batch insert, status update, fire-and-forget webhook, and revalidatePath. RLS migration adds missing SELECT policy for anonymous feedback operations and UPDATE policy for form status changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Public feedback page routing and 404 handling</name>
  <files>
    src/app/feedback/[slug]/page.tsx
    src/app/feedback/[slug]/not-found.tsx
  </files>
  <action>
    **page.tsx (Server Component):**
    Create `src/app/feedback/[slug]/page.tsx` as an async Server Component:

    1. Use Next.js 15 async params pattern: `params: Promise<{ slug: string }>`, then `const { slug } = await params`
    2. Create Supabase client with `createClient()` from `@/lib/supabase/server`
    3. Query forms table with nested email_variants and feedback_responses:
       ```
       .from('forms')
       .select(`
         id, client_name, slug, status, webhook_url,
         email_variants (
           id, email_type, variant_number, subject_line, email_body, sort_order
         )
       `)
       .eq('slug', slug)
       .single()
       ```
       Note: Do NOT filter by `status = 'active'` -- we need to load both active AND completed forms (completed shows read-only view).
    4. If no form found, call `notFound()` from `next/navigation`
    5. Type assertion: cast result `as unknown as FormWithVariants` (define inline type matching the query shape)
    6. Define inline types:
       - `EmailVariantData`: { id: string, email_type: EmailType, variant_number: number, subject_line: string, email_body: string, sort_order: number }
       - `FormWithVariants`: { id: string, client_name: string, slug: string, status: 'active' | 'completed', webhook_url: string | null, email_variants: EmailVariantData[] }
       - `EmailType`: 'eerste_mail' | 'opvolgmail_1' | 'opvolgmail_2'
    7. If form.status === 'completed':
       - Query feedback_responses for this form: `.from('feedback_responses').select('id, variant_id, feedback_text, submitted_at').eq('form_id', form.id)`
       - Render `<ReadOnlyView form={form} feedbackResponses={responses} />` (import from `./_components/ReadOnlyView`)
    8. If form.status === 'active':
       - Sort email_variants by sort_order
       - Render `<FeedbackForm form={form} />` (import from `./_components/FeedbackForm`)
    9. Add layout wrapper: full-width container with max-w-3xl mx-auto, padding, min-h-screen
    10. Add header: "NextWave Solutions" text branding (small, muted text at top), then "Invulformulier voor {client_name}" as h1
    11. Add intro text paragraph: "Hieronder vind je de e-mailvarianten die wij voor je hebben opgesteld. Laat per variant je feedback achter." (only show for active forms)
    12. Export metadata: `export const metadata = { title: 'Feedback formulier' }`

    Note: The page.tsx renders the header/intro AND either FeedbackForm or ReadOnlyView. The components handle ONLY their specific UI concern (form fields or read-only display).

    **not-found.tsx:**
    Create `src/app/feedback/[slug]/not-found.tsx` following the pattern from `src/app/dashboard/[id]/not-found.tsx`:
    - Centered layout with min-h-[50vh]
    - Dutch heading: "Formulier niet gevonden"
    - Description: "Dit feedbackformulier bestaat niet of is verwijderd."
    - Link to homepage "/" with text "Terug naar homepage"
    - Do NOT link to /dashboard (this is a public page, clients should not see dashboard links)
  </action>
  <verify>
    - `npx tsc --noEmit` passes (even though FeedbackForm and ReadOnlyView components don't exist yet -- they will be created in Plan 05-02. If import errors occur, add placeholder comments noting the dependency)
    - File exists: `src/app/feedback/[slug]/page.tsx`
    - File exists: `src/app/feedback/[slug]/not-found.tsx`
    - `npm run build` may show warnings about missing component imports -- this is expected, they'll be created in Plan 05-02

    NOTE: If TypeScript/build fails due to missing FeedbackForm/ReadOnlyView imports, create minimal placeholder files:
    - `src/app/feedback/[slug]/_components/FeedbackForm.tsx`: `'use client'; export function FeedbackForm({ form }: any) { return <div>Loading form...</div> }`
    - `src/app/feedback/[slug]/_components/ReadOnlyView.tsx`: `export function ReadOnlyView({ form, feedbackResponses }: any) { return <div>Loading...</div> }`
    These will be properly implemented in Plan 05-02.
  </verify>
  <done>
    Public feedback page at /feedback/[slug] loads without authentication, fetches form data with nested variants, routes to FeedbackForm (active) or ReadOnlyView (completed), shows 404 for invalid slugs with Dutch messaging, and displays header with "Invulformulier voor [Klantnaam]" and NextWave Solutions branding.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes without errors
- `npm run build` completes successfully (with possible warnings for placeholder components)
- Server Action file exports submitFeedbackAction
- Migration SQL file contains both SELECT and UPDATE policies for anon role
- Page renders at /feedback/[slug] route (Server Component with data fetch)
- Invalid slugs trigger not-found.tsx (404 response)
</verification>

<success_criteria>
1. submitFeedbackAction exists and handles: batch insert feedback, update form status, fire-and-forget webhook, revalidatePath
2. RLS migration adds anon SELECT on feedback_responses and anon UPDATE on forms (status only)
3. /feedback/[slug] page loads form data without authentication using Server Component
4. Invalid slugs return 404 with Dutch message
5. Active forms route to FeedbackForm component, completed forms route to ReadOnlyView component
6. Page header shows "Invulformulier voor [Klantnaam]" with NextWave Solutions branding
</success_criteria>

<output>
After completion, create `.planning/phases/05-public-feedback-form/05-01-SUMMARY.md`
</output>
