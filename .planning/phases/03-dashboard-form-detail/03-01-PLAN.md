---
phase: 03-dashboard-form-detail
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/dashboard/[id]/page.tsx
  - src/app/dashboard/[id]/loading.tsx
  - src/app/dashboard/[id]/not-found.tsx
autonomous: true

must_haves:
  truths:
    - "Form detail page displays client name, creation date, status, and shareable link"
    - "Email variants are grouped by type with section headers (Eerste mail, Opvolgmail 1, Opvolgmail 2)"
    - "Each variant displays subject line and email body"
    - "Submitted feedback appears in green-highlighted cards under corresponding variants"
    - "Variants without feedback show gray 'Nog geen feedback ontvangen' placeholder"
    - "Navigation from dashboard home to form detail works correctly (Bekijken link)"
    - "Invalid form IDs show 404 not-found page"
  artifacts:
    - path: "src/app/dashboard/[id]/page.tsx"
      provides: "Form detail page with nested data fetch, variant grouping, and feedback display"
      min_lines: 80
    - path: "src/app/dashboard/[id]/loading.tsx"
      provides: "Loading skeleton for form detail page"
      min_lines: 10
    - path: "src/app/dashboard/[id]/not-found.tsx"
      provides: "Custom 404 page for invalid form IDs"
      min_lines: 10
  key_links:
    - from: "src/app/dashboard/[id]/page.tsx"
      to: "supabase.from('forms').select(...)"
      via: "Server Component async data fetch with nested join"
      pattern: "from\\(['\"]forms['\"]\\)\\.select.*email_variants.*feedback_responses"
    - from: "src/app/dashboard/[id]/page.tsx"
      to: "notFound()"
      via: "import from next/navigation, called when form is null"
      pattern: "notFound\\(\\)"
    - from: "src/app/dashboard/_components/forms-table.tsx"
      to: "src/app/dashboard/[id]/page.tsx"
      via: "Link href /dashboard/[id] (Bekijken button already exists)"
      pattern: "href=.*dashboard/.*id"
    - from: "src/app/dashboard/[id]/page.tsx"
      to: "src/app/dashboard/_components/copy-link-button.tsx"
      via: "import CopyLinkButton for shareable link display"
      pattern: "import.*CopyLinkButton"
---

<objective>
Build the form detail page at /dashboard/[id] that displays a form's complete information: client name, creation date, status, shareable link, all email variants grouped by type (Eerste mail, Opvolgmail 1, Opvolgmail 2), and feedback responses highlighted in green or gray placeholder when absent.

Purpose: The agency needs to view individual form details to review which email variants were sent to a client and what feedback was received. This is the read-only detail view linked from the dashboard home's "Bekijken" button.

Output: Working form detail page with loading skeleton and 404 handling.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dashboard-form-detail/03-RESEARCH.md
@.planning/phases/02-dashboard-home/02-01-SUMMARY.md

Key existing files to reference:
@src/types/database.types.ts
@src/lib/supabase/server.ts
@src/lib/utils.ts
@src/components/status-badge.tsx
@src/components/page-header.tsx
@src/components/ui/card.tsx
@src/app/dashboard/_components/copy-link-button.tsx
@src/app/dashboard/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create form detail page with nested data fetch, variant grouping, and feedback display</name>
  <files>src/app/dashboard/[id]/page.tsx</files>
  <action>
Create `src/app/dashboard/[id]/page.tsx` as an async Server Component. Follow the established patterns from `src/app/dashboard/page.tsx` exactly.

**Data fetching:**
- Import `createClient` from `@/lib/supabase/server`
- Await params (Next.js 15 requirement): `const { id } = await params` with type `params: Promise<{ id: string }>`
- Single Supabase nested query fetching form + email_variants + feedback_responses:
  ```
  .from('forms')
  .select(`
    id, client_name, slug, status, webhook_url, created_at,
    email_variants (
      id, email_type, variant_number, subject_line, email_body, sort_order,
      feedback_responses (
        id, feedback_text, submitted_at
      )
    )
  `)
  .eq('id', id)
  .order('sort_order', { referencedTable: 'email_variants', ascending: true })
  .single()
  ```
- If error or !data, call `notFound()` from `next/navigation`

**Type for query result:**
- Define `FormWithVariantsAndFeedback` type inline or at top of file matching the nested query shape. Use the existing enum types from database.types.ts for email_type and status.

**Variant grouping:**
- Define `EMAIL_TYPE_LABELS` constant: `{ eerste_mail: 'Eerste mail', opvolgmail_1: 'Opvolgmail 1', opvolgmail_2: 'Opvolgmail 2' }`
- Define `EMAIL_TYPE_ORDER` array: `['eerste_mail', 'opvolgmail_1', 'opvolgmail_2']`
- Group variants using `Array.reduce()` into `Record<string, typeof form.email_variants>`
- Only render sections that have variants (skip empty type groups)

**Page layout (top to bottom):**

1. **Back navigation** - Link back to /dashboard with ArrowLeft icon from lucide-react and text "Terug naar overzicht"

2. **PageHeader** - Reuse existing component with `title={form.client_name}` and `description` showing formatted creation date using `formatDate` from `@/lib/utils` (produces "10 feb 2026" style). Put StatusBadge in the PageHeader children slot (right side).

3. **Form metadata card** - A Card with:
   - Row showing "Status:" with StatusBadge component
   - Row showing "Aangemaakt op:" with formatted date (use `formatDate`)
   - Row showing "Deelbare link:" with CopyLinkButton from `../_components/copy-link-button` using `generatePublicUrl(form.slug)` from `@/lib/utils`
   - Use a simple grid/list layout with `text-sm` for labels and values

4. **Variant sections** - For each type in EMAIL_TYPE_ORDER that has variants:
   - Section header `<h2>` with Dutch label from EMAIL_TYPE_LABELS (e.g., "Eerste mail")
   - For each variant in that group, render a Card:
     - CardHeader with CardTitle showing `Variant {variant.variant_number}: {variant.subject_line}`
     - CardContent with:
       - Email body displayed in a `<div className="whitespace-pre-wrap text-sm text-muted-foreground">` (preserves line breaks)
       - Below the body, a feedback section:
         - If `variant.feedback_responses.length > 0`: render each feedback in a nested card/div with `className="bg-green-50 border border-green-200 rounded-lg p-4 mt-4"` containing:
           - `feedback_text` in `<p className="text-sm">`
           - `submitted_at` formatted with `formatDate` in `<p className="text-xs text-muted-foreground mt-1">`
         - If no feedback: render a div with `className="bg-gray-50 border border-gray-200 rounded-lg p-4 mt-4"` containing:
           - `<p className="text-sm text-muted-foreground italic">Nog geen feedback ontvangen</p>`

**Imports to use:**
- `createClient` from `@/lib/supabase/server`
- `notFound` from `next/navigation`
- `Link` from `next/link`
- `ArrowLeft` from `lucide-react`
- `PageHeader` from `@/components/page-header`
- `StatusBadge` from `@/components/status-badge`
- `Card, CardContent, CardHeader, CardTitle` from `@/components/ui/card`
- `CopyLinkButton` from `../_components/copy-link-button`
- `formatDate, generatePublicUrl` from `@/lib/utils`

Do NOT use 'use client' directive. This is a Server Component.
Do NOT create separate queries for variants and feedback. Use the single nested query.
Do NOT use date-fns or dayjs. Use the existing formatDate utility.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root - zero TypeScript errors.
Run `npx next build` - build succeeds with no errors.
Verify file exists at src/app/dashboard/[id]/page.tsx.
  </verify>
  <done>
Form detail page renders at /dashboard/[id] showing: (1) back link to dashboard, (2) client name in header with status badge, (3) metadata card with status, date, and shareable link, (4) variant sections grouped by email type with Dutch headers, (5) green-highlighted feedback cards or gray "Nog geen feedback ontvangen" placeholder per variant. Invalid IDs trigger 404.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create loading skeleton and not-found page</name>
  <files>src/app/dashboard/[id]/loading.tsx, src/app/dashboard/[id]/not-found.tsx</files>
  <action>
**loading.tsx** - Create a loading skeleton matching the form detail page layout. Follow the pattern from `src/app/dashboard/loading.tsx`.

- Import Skeleton from `@/components/ui/skeleton`
- Import Card, CardContent, CardHeader from `@/components/ui/card`
- Layout:
  1. Back link skeleton: `<Skeleton className="h-5 w-40" />` (for "Terug naar overzicht")
  2. Header skeleton: `<Skeleton className="h-8 w-64" />` (for title) and `<Skeleton className="h-5 w-48" />` (for description)
  3. Metadata card skeleton: Card with 3 rows of Skeleton pairs (label + value)
  4. Two variant section skeletons: each with a `<Skeleton className="h-7 w-40 mb-4" />` (section header) and 2 Card skeletons with header line and 3 body lines
- Use `space-y-6` as the outer container, matching the page layout

**not-found.tsx** - Custom 404 for invalid form IDs.

- Simple centered layout with:
  - Heading: "Formulier niet gevonden"
  - Description: "Het formulier dat je zoekt bestaat niet of is verwijderd."
  - Link button back to /dashboard: "Terug naar overzicht"
- Import Link from `next/link`, Button from `@/components/ui/button`
- Use a centered flexbox layout with `min-h-[50vh]` for vertical centering
- This is a Server Component (no 'use client')
  </action>
  <verify>
Run `npx tsc --noEmit` from project root - zero TypeScript errors.
Run `npx next build` - build succeeds.
Verify files exist at src/app/dashboard/[id]/loading.tsx and src/app/dashboard/[id]/not-found.tsx.
  </verify>
  <done>
Loading state shows content-shaped skeleton placeholders while data loads. Invalid form IDs display Dutch 404 page with "Formulier niet gevonden" message and link back to dashboard.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes with zero errors
2. Build: `npx next build` succeeds
3. Route structure: /dashboard/[id] route exists and is accessible
4. Navigation: Bekijken link from dashboard home (/dashboard) correctly navigates to /dashboard/[id]
5. Data display: Page renders form metadata, variant sections, and feedback cards
6. 404 handling: Non-existent form IDs show not-found page
7. Loading state: loading.tsx renders while page data is fetching
</verification>

<success_criteria>
- Form detail page at /dashboard/[id] displays client name, creation date, status badge, and shareable link
- Email variants grouped by type with Dutch section headers (Eerste mail, Opvolgmail 1, Opvolgmail 2)
- Each variant shows subject line and email body content
- Feedback displayed in green-highlighted cards (bg-green-50, border-green-200) under corresponding variants
- Variants without feedback show gray "Nog geen feedback ontvangen" placeholder
- Invalid form IDs render 404 not-found page with Dutch text
- Loading skeleton displays during data fetch
- No new dependencies installed (all existing)
- TypeScript and build pass with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-dashboard-form-detail/03-01-SUMMARY.md`
</output>
