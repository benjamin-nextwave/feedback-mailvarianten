---
phase: 04-form-creation-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/components/ui/form.tsx
  - src/components/ui/dialog.tsx
  - src/components/ui/alert-dialog.tsx
  - src/components/ui/switch.tsx
  - src/lib/validations/form-schema.ts
  - src/lib/actions/form-actions.ts
autonomous: true

must_haves:
  truths:
    - "Zod schema validates klantnaam (required), webhook_url (optional URL), eerste_mail variants (1-5 with subject+body), optional opvolgmail sections"
    - "Server Action creates form with auto-generated slug, inserts variants by email type, and redirects to dashboard"
    - "Server Action deletes form by ID and redirects to dashboard"
  artifacts:
    - path: "src/lib/validations/form-schema.ts"
      provides: "Zod form creation schema with conditional validation for opvolgmail toggles"
      exports: ["formSchema", "FormSchemaType"]
    - path: "src/lib/actions/form-actions.ts"
      provides: "Server Actions for creating and deleting forms"
      exports: ["createFormAction", "deleteFormAction"]
    - path: "src/components/ui/form.tsx"
      provides: "shadcn Form component for react-hook-form integration"
    - path: "src/components/ui/switch.tsx"
      provides: "shadcn Switch component for opvolgmail toggles"
    - path: "src/components/ui/alert-dialog.tsx"
      provides: "shadcn AlertDialog component for delete confirmation"
  key_links:
    - from: "src/lib/actions/form-actions.ts"
      to: "src/lib/supabase/server.ts"
      via: "createClient() for database operations"
      pattern: "createClient"
    - from: "src/lib/actions/form-actions.ts"
      to: "src/lib/validations/form-schema.ts"
      via: "formSchema.safeParse for server-side validation"
      pattern: "formSchema\\.safeParse"
    - from: "src/lib/actions/form-actions.ts"
      to: "revalidatePath + redirect"
      via: "cache invalidation after mutations"
      pattern: "revalidatePath.*redirect"
---

<objective>
Install form handling dependencies (react-hook-form, zod, slugify), add shadcn form/dialog/switch components, create the Zod validation schema for form creation, and implement Server Actions for creating and deleting forms.

Purpose: This is the foundation layer for Phase 4 - both the form creation UI (Plan 02) and the delete dialog (Plan 03) depend on the schema, actions, and UI components created here.
Output: Validated form schema, working server actions, and all UI primitives needed by subsequent plans.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-form-creation-management/04-RESEARCH.md
@src/types/database.types.ts
@src/lib/supabase/server.ts
@src/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and add shadcn components</name>
  <files>package.json, src/components/ui/form.tsx, src/components/ui/dialog.tsx, src/components/ui/alert-dialog.tsx, src/components/ui/switch.tsx</files>
  <action>
1. Install npm packages:
   ```
   npm install react-hook-form zod @hookform/resolvers slugify
   ```
   Note: @types/slugify is NOT needed — slugify ships its own TypeScript declarations.

2. Add shadcn/ui components via CLI:
   ```
   npx shadcn@latest add form dialog alert-dialog switch --yes
   ```
   This will create form.tsx (integrates react-hook-form with accessible form fields), dialog.tsx (for general modals), alert-dialog.tsx (for delete confirmation - better accessibility than Dialog for destructive actions), and switch.tsx (for opvolgmail toggles).

3. Verify all components installed correctly by checking files exist in src/components/ui/.
  </action>
  <verify>
Run `npm ls react-hook-form zod @hookform/resolvers slugify` to confirm packages installed.
Check files exist: src/components/ui/form.tsx, src/components/ui/dialog.tsx, src/components/ui/alert-dialog.tsx, src/components/ui/switch.tsx.
Run `npx tsc --noEmit` to confirm TypeScript compiles.
  </verify>
  <done>All four npm packages installed. All four shadcn components exist in src/components/ui/. TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create Zod validation schema and Server Actions</name>
  <files>src/lib/validations/form-schema.ts, src/lib/actions/form-actions.ts</files>
  <action>
**File 1: src/lib/validations/form-schema.ts**

Create Zod schema for form creation with these rules:
- `klantnaam`: string, min 1 char, required. Dutch error: "Klantnaam is verplicht"
- `webhook_url`: string, optional. If provided must be valid URL. Use `z.string().url("Ongeldige URL").optional().or(z.literal(''))` to allow empty string
- `eerste_mail_variants`: array of { subject: string (min 1, "Onderwerp is verplicht"), body: string (min 1, "Inhoud is verplicht") }. Min 1, max 5 items
- `opvolgmail_1_enabled`: boolean, default false
- `opvolgmail_1_variants`: array of variant schema, optional
- `opvolgmail_2_enabled`: boolean, default false
- `opvolgmail_2_variants`: array of variant schema, optional

Add `.superRefine()` for conditional validation:
- If opvolgmail_1_enabled is true, opvolgmail_1_variants must have 1-5 items
- If opvolgmail_2_enabled is true, opvolgmail_2_variants must have 1-5 items
- opvolgmail_2_enabled can only be true if opvolgmail_1_enabled is true (enforce in UI, but also validate here)

Export: `formSchema` (the Zod schema) and `FormSchemaType` (z.infer type alias)
Also export `variantSchema` for reuse.

**File 2: src/lib/actions/form-actions.ts**

Mark with `'use server'` at top.

**createFormAction(data: FormSchemaType):**
1. Import and call `createClient()` from `@/lib/supabase/server`
2. Server-side validate with `formSchema.safeParse(data)` — return `{ errors }` if invalid
3. Generate slug: import slugify, create base slug from klantnaam with `{ lower: true, strict: true, locale: 'nl' }`, append `-` + `Math.random().toString(36).substring(2, 8)` for uniqueness
4. Check slug uniqueness against database. If collision, retry up to 3 times with new random suffix
5. Insert form into `forms` table: `{ client_name: data.klantnaam, slug, webhook_url: data.webhook_url || null, status: 'active' }`. Use `.select().single()` to get back the created form with its ID
6. Build variants array for batch insert into `email_variants`:
   - Map eerste_mail_variants with `email_type: 'eerste_mail'`, variant_number (1-indexed), subject_line, email_body, sort_order starting at 0
   - If opvolgmail_1_enabled, map opvolgmail_1_variants with `email_type: 'opvolgmail_1'`, variant_number (1-indexed), sort_order continuing from eerste_mail count
   - If opvolgmail_2_enabled, map opvolgmail_2_variants with `email_type: 'opvolgmail_2'`, variant_number (1-indexed), sort_order continuing from previous counts
   - Each variant needs `form_id` from the created form
7. Insert all variants in single batch: `supabase.from('email_variants').insert(variants)`
8. If any DB error, return `{ message: 'Er ging iets mis bij het aanmaken' }` (Dutch)
9. Call `revalidatePath('/dashboard')` then `redirect('/dashboard')`

**deleteFormAction(formId: string):**
1. Import and call `createClient()`
2. Delete from `forms` table where `id` equals formId (CASCADE will handle variants and feedback)
3. If error, return `{ message: 'Er ging iets mis bij het verwijderen' }`
4. Call `revalidatePath('/dashboard')` then `redirect('/dashboard')`

Import types: use `FormSchemaType` from form-schema.ts, `revalidatePath` from 'next/cache', `redirect` from 'next/navigation'.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm both files compile without errors.
Verify exports: the schema file should export formSchema, FormSchemaType, variantSchema. The actions file should export createFormAction, deleteFormAction.
Run `npm run build` to confirm Next.js can resolve all imports and Server Actions are valid.
  </verify>
  <done>
- form-schema.ts exports formSchema with conditional validation for all email types, plus FormSchemaType and variantSchema
- form-actions.ts exports createFormAction (validates, generates slug, inserts form + variants, revalidates, redirects) and deleteFormAction (deletes form, revalidates, redirects)
- Both files compile. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `npm ls react-hook-form zod @hookform/resolvers slugify` shows all 4 packages installed
2. Files exist: src/components/ui/form.tsx, dialog.tsx, alert-dialog.tsx, switch.tsx
3. Files exist: src/lib/validations/form-schema.ts, src/lib/actions/form-actions.ts
4. `npx tsc --noEmit` passes with zero errors
5. `npm run build` succeeds
</verification>

<success_criteria>
- Four npm packages (react-hook-form, zod, @hookform/resolvers, slugify) are installed
- Four shadcn components (form, dialog, alert-dialog, switch) are added to src/components/ui/
- Zod schema validates all form fields with conditional opvolgmail validation and Dutch error messages
- createFormAction generates unique slug, inserts form + variants into Supabase, revalidates and redirects
- deleteFormAction removes form from Supabase, revalidates and redirects
- TypeScript compiles and Next.js builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-form-creation-management/04-01-SUMMARY.md`
</output>
