---
phase: 04-form-creation-management
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/dashboard/forms/create/page.tsx
  - src/app/dashboard/forms/create/CreateFormClient.tsx
  - src/components/forms/VariantFieldArray.tsx
  - src/app/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Agency can navigate to form creation page from dashboard"
    - "Agency can enter Klantnaam (required) and Webhook URL (optional)"
    - "Agency can add 1-5 variants for Eerste mail with subject and body fields"
    - "Agency can toggle Opvolgmail 1 to add follow-up email variants"
    - "Agency can toggle Opvolgmail 2 only when Opvolgmail 1 is enabled"
    - "Submitting form creates it in database and redirects to dashboard"
    - "Created form appears immediately in dashboard list"
  artifacts:
    - path: "src/app/dashboard/forms/create/page.tsx"
      provides: "Server Component wrapper for form creation page"
      min_lines: 5
    - path: "src/app/dashboard/forms/create/CreateFormClient.tsx"
      provides: "Client Component with full form creation UI using react-hook-form"
      min_lines: 100
    - path: "src/components/forms/VariantFieldArray.tsx"
      provides: "Reusable dynamic variant fields component with add/remove"
      min_lines: 50
  key_links:
    - from: "src/app/dashboard/forms/create/CreateFormClient.tsx"
      to: "src/lib/validations/form-schema.ts"
      via: "zodResolver(formSchema) for client validation"
      pattern: "zodResolver.*formSchema"
    - from: "src/app/dashboard/forms/create/CreateFormClient.tsx"
      to: "src/lib/actions/form-actions.ts"
      via: "createFormAction call on submit"
      pattern: "createFormAction"
    - from: "src/components/forms/VariantFieldArray.tsx"
      to: "react-hook-form useFieldArray"
      via: "Dynamic field management with field.id keys"
      pattern: "useFieldArray"
    - from: "src/app/dashboard/page.tsx"
      to: "src/app/dashboard/forms/create/page.tsx"
      via: "Nieuw formulier button link in PageHeader"
      pattern: "forms/create"
---

<objective>
Build the form creation page where the agency creates new feedback forms with client name, optional webhook URL, and 1-5 email variants per type (Eerste mail required, Opvolgmail 1 and 2 optional with toggles).

Purpose: This is the core creation flow - the primary way forms enter the system. Without this, there is no content for the public feedback form (Phase 5).
Output: Working form creation page at /dashboard/forms/create with full validation and dynamic variant management.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-form-creation-management/04-RESEARCH.md
@.planning/phases/04-form-creation-management/04-01-SUMMARY.md
@src/types/database.types.ts
@src/lib/validations/form-schema.ts
@src/lib/actions/form-actions.ts
@src/components/ui/form.tsx
@src/components/ui/switch.tsx
@src/app/dashboard/page.tsx
@src/components/page-header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VariantFieldArray reusable component</name>
  <files>src/components/forms/VariantFieldArray.tsx</files>
  <action>
Create a reusable Client Component for managing dynamic variant fields (used for each email type section).

**Props interface:**
```typescript
interface VariantFieldArrayProps {
  control: Control<FormSchemaType>
  name: "eerste_mail_variants" | "opvolgmail_1_variants" | "opvolgmail_2_variants"
  label: string  // e.g. "Eerste mail", "Opvolgmail 1"
  minItems?: number  // defaults to 1 for eerste_mail, 0 for opvolgmail
  maxItems?: number  // defaults to 5
}
```

**Implementation:**
- Mark `'use client'` at top
- Use `useFieldArray` from react-hook-form with `control` and `name` props
- CRITICAL: Use `field.id` as key in map, NOT array index (causes re-render bugs)
- Render section with `label` as heading (h3, font-semibold text-lg)
- For each field, render a Card containing:
  - Header: "Variant {index + 1}" label with remove button (X icon, only if fields.length > minItems)
  - FormField for `${name}.${index}.subject` with FormLabel "Onderwerp", Input, FormMessage
  - FormField for `${name}.${index}.body` with FormLabel "Inhoud", Textarea (rows={4}), FormMessage
- "Variant toevoegen" button at bottom with Plus icon, disabled when fields.length >= maxItems
- `append({ subject: '', body: '' })` on add click — MUST provide all fields, not empty object

**Styling:**
- Cards with subtle border, p-4
- Remove button: variant="ghost" size="icon" with Trash2 icon (text-muted-foreground hover:text-destructive)
- Add button: variant="outline" with dashed border style
- Space between variants: space-y-4
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm component compiles.
Check that useFieldArray is imported from react-hook-form.
Check that field.id is used as key (not index).
  </verify>
  <done>VariantFieldArray component renders dynamic variant cards with add/remove, uses field.id for keys, enforces min/max item limits, and displays Dutch labels (Onderwerp, Inhoud, Variant toevoegen).</done>
</task>

<task type="auto">
  <name>Task 2: Create form creation page and client component</name>
  <files>src/app/dashboard/forms/create/page.tsx, src/app/dashboard/forms/create/CreateFormClient.tsx, src/app/dashboard/page.tsx</files>
  <action>
**File 1: src/app/dashboard/forms/create/page.tsx (Server Component)**

Simple wrapper:
```typescript
import { CreateFormClient } from './CreateFormClient'
import { PageHeader } from '@/components/page-header'

export default function CreateFormPage() {
  return (
    <div className="space-y-6">
      <PageHeader
        title="Nieuw formulier"
        description="Maak een nieuw feedback formulier aan voor een klant"
      />
      <CreateFormClient />
    </div>
  )
}
```

**File 2: src/app/dashboard/forms/create/CreateFormClient.tsx (Client Component)**

Mark `'use client'`.

1. **Setup react-hook-form:**
   - Import `useForm` from react-hook-form, `zodResolver` from @hookform/resolvers/zod
   - Import `formSchema, FormSchemaType` from @/lib/validations/form-schema
   - Import `createFormAction` from @/lib/actions/form-actions
   - Initialize form with `useForm<FormSchemaType>({ resolver: zodResolver(formSchema), defaultValues: { klantnaam: '', webhook_url: '', eerste_mail_variants: [{ subject: '', body: '' }], opvolgmail_1_enabled: false, opvolgmail_1_variants: [{ subject: '', body: '' }], opvolgmail_2_enabled: false, opvolgmail_2_variants: [{ subject: '', body: '' }] } })`

2. **Watch toggle states:**
   - `const opvolgmail1Enabled = form.watch('opvolgmail_1_enabled')`
   - `const opvolgmail2Enabled = form.watch('opvolgmail_2_enabled')`
   - When opvolgmail_1 is toggled OFF, also set opvolgmail_2_enabled to false and reset its variants

3. **Submit handler:**
   - `async function onSubmit(data: FormSchemaType)` — set loading state, call `createFormAction(data)`
   - If result has errors, use `form.setError()` to display server validation errors
   - If result has message (general error), display in a div with text-destructive class
   - Use `useState` for `isSubmitting` to show loading state on submit button

4. **Form layout:**
   - Wrap in shadcn `<Form {...form}>` and `<form onSubmit={form.handleSubmit(onSubmit)}>`
   - **Section 1: Basisgegevens** (Card)
     - FormField for `klantnaam`: FormLabel "Klantnaam *", Input placeholder "Bijv. Acme Corporation", FormMessage
     - FormField for `webhook_url`: FormLabel "Webhook URL", Input placeholder "https://...", FormDescription "Optioneel. Ontvang een notificatie wanneer feedback binnenkomt.", FormMessage
   - **Section 2: Eerste mail** (always visible)
     - `<VariantFieldArray control={form.control} name="eerste_mail_variants" label="Eerste mail" minItems={1} maxItems={5} />`
   - **Section 3: Opvolgmail 1** (toggle)
     - Card with flex row: Label "Opvolgmail 1" + description "Voeg een eerste opvolgmail toe" + Switch
     - Switch: `checked={opvolgmail1Enabled}`, `onCheckedChange={(checked) => { form.setValue('opvolgmail_1_enabled', checked); if (!checked) { form.setValue('opvolgmail_2_enabled', false); form.setValue('opvolgmail_1_variants', [{ subject: '', body: '' }]); form.setValue('opvolgmail_2_variants', [{ subject: '', body: '' }]); } }}`
     - Conditionally render: `{opvolgmail1Enabled && <VariantFieldArray ... name="opvolgmail_1_variants" label="Opvolgmail 1 varianten" />}`
   - **Section 4: Opvolgmail 2** (toggle, only visible when opvolgmail 1 is enabled)
     - Same pattern as Section 3, but only rendered when `opvolgmail1Enabled` is true
     - Switch for opvolgmail_2_enabled
     - Conditionally render VariantFieldArray for opvolgmail_2_variants
   - **Submit area:**
     - Flex row with justify-end
     - Link "Annuleren" to /dashboard (variant="outline", use Next.js Link styled as Button)
     - Submit Button "Formulier aanmaken" with loading state "Aanmaken..." — disabled when isSubmitting
     - If general error message exists, show above buttons in text-destructive

**File 3: Update src/app/dashboard/page.tsx**

Add a "Nieuw formulier" button in the PageHeader action slot:
```tsx
import Link from 'next/link'
import { Button } from '@/components/ui/button'
import { Plus } from 'lucide-react'

<PageHeader
  title="Formulieren"
  description="Beheer je feedback formulieren"
>
  <Link href="/dashboard/forms/create">
    <Button>
      <Plus className="mr-2 h-4 w-4" />
      Nieuw formulier
    </Button>
  </Link>
</PageHeader>
```
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm all files compile.
Run `npm run build` to verify the /dashboard/forms/create route is registered.
Check that CreateFormClient imports and uses formSchema, createFormAction, and VariantFieldArray.
Check that Opvolgmail 2 section only appears when Opvolgmail 1 is enabled.
Check that dashboard page has "Nieuw formulier" button linking to /dashboard/forms/create.
  </verify>
  <done>
- Form creation page at /dashboard/forms/create with Server Component wrapper and Client Component form
- Klantnaam (required) and Webhook URL (optional) fields in Basisgegevens card
- Eerste mail section with 1-5 dynamic variant fields (subject + body)
- Opvolgmail 1 toggle showing variant fields when enabled
- Opvolgmail 2 toggle only visible when Opvolgmail 1 is enabled
- Form submits via createFormAction, validates with Zod, shows errors, redirects on success
- Dashboard page has "Nieuw formulier" button in header
- TypeScript compiles and Next.js builds
  </done>
</task>

</tasks>

<verification>
1. Navigate to /dashboard — "Nieuw formulier" button visible in header
2. Click button — navigates to /dashboard/forms/create
3. Form shows Klantnaam field, Webhook URL field, Eerste mail variants section
4. Can add up to 5 variants, remove down to 1 for Eerste mail
5. Toggle Opvolgmail 1 — variant fields appear
6. Toggle Opvolgmail 2 — only available when Opvolgmail 1 is enabled
7. Submit with empty Klantnaam — validation error "Klantnaam is verplicht"
8. Submit valid form — form created, redirected to dashboard, new form visible in list
9. `npm run build` succeeds
</verification>

<success_criteria>
- Form creation page renders at /dashboard/forms/create
- Klantnaam is required, Webhook URL is optional
- 1-5 variants per email type with dynamic add/remove
- Opvolgmail toggles show/hide conditional sections correctly
- Form submission creates form + variants in database via Server Action
- Dashboard immediately shows new form after creation (revalidatePath works)
- All validation errors display in Dutch
</success_criteria>

<output>
After completion, create `.planning/phases/04-form-creation-management/04-02-SUMMARY.md`
</output>
